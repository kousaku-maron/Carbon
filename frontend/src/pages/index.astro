---
import BaseLayout from '../layouts/BaseLayout.astro';
import { listNotes } from '../lib/server/api';
import type { NoteResponse } from '../lib/server/api';
import { markdownToExcerpt } from '../lib/server/markdown';
import { PostCard } from '../components/PostCard';
import { EmptyState } from '../components/EmptyState';

let notes: NoteResponse[] = [];
let error = '';
const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

try {
  notes = await listNotes(Astro.locals.db, user.id);
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
}
---

<BaseLayout title="Notes | Carbon">
  <div class="feed-header">
    <h1 class="feed-heading">All notes</h1>
    {notes.length > 0 && (
      <span class="feed-count">{notes.length}</span>
    )}
  </div>

  {error ? (
    <div class="feed-message">
      <p class="muted">{error}</p>
    </div>
  ) : null}

  {notes.length === 0 && !error ? (
    <EmptyState
      title="No notes yet"
      description="Create your first markdown note."
      actionLabel="New note"
      actionHref="/notes/new"
    />
  ) : (
    <section class="post-list">
      {notes.map((note) => (
        <PostCard
          id={note.id}
          title={note.title}
          summary={markdownToExcerpt(note.content, 160) || 'No content'}
          createdAt={note.created_at}
          updatedAt={note.updated_at}
        />
      ))}
    </section>
  )}
</BaseLayout>

<style>
  .feed-header {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 8px;
  }
  .feed-heading {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    letter-spacing: -0.02em;
  }
  .feed-count {
    font-size: 0.75rem;
    color: var(--muted);
    font-weight: 500;
  }
  .feed-message {
    padding: 32px 0;
  }
</style>
