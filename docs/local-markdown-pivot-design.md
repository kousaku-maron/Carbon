# ローカルMarkdown管理アプリ設計書（ToDo要素排除版）

## 1. 目的

既存の ToDo/カンバンアプリを、以下を満たすローカルファーストな Markdown 管理アプリへ転換する。

- データはユーザーが選択したローカルフォルダ内の `*.md` を直接利用する
- UI は Notion ライクな快適性を持ちつつ、Obsidian ライクなファイル主権を維持する
- 認証に成功したユーザーのみ Markdown 管理機能へアクセスできる

### 1.1 前提（テンプレート由来）

このリポジトリは、Tauri + Cloudflare Workers + 認証 + カンバン機能を含む既存テンプレートコードをベースに作成されたものである。  
本設計は「テンプレート機能を改善する」のではなく、「テンプレートを土台としてローカル Markdown 管理アプリへピボットする」ための開発指針として扱う。

## 2. スコープ

### 2.1 対象

- Tauri + React で動作するデスクトップアプリ
- 既存の認証（sign-up / sign-in / sign-out / session確認）を維持
- 認証済みユーザーのみが Workspace（Markdown 管理 UI）に遷移可能
- Vault（ローカルフォルダ）選択、ドキュメントツリー表示、ノート編集、保存
- TipTap ベースのリッチエディタ
- Markdown との相互変換（入出力）

### 2.2 非対象（明示的に除外）

- ToDo/カンバン機能（カード、ステータス列、並び替え API）
- タスク専用画面、進捗ボード、工数管理
- Cloudflare Workers のカード管理 API（`/api/cards`, `/api/reorder`）への依存実行
- DB（Neon/PostgreSQL）を必須とする保存方式
- frontmatter の解析・活用を前提にした機能

## 3. ランタイム方針

- 採用: **Tauri を継続利用**
- 理由:
  - 既存コードベースに Tauri が導入済みで移行コストが低い
  - ローカルファイル操作、フォルダ選択、将来のファイル監視を実装しやすい
  - ブラウザ単体より、永続的なローカルアクセス要件に適合する

## 4. システム構成

```text
[React UI]
  ├─ Auth Screen（Login / SignUp）
  ├─ Workspace Shell（2ペイン）
  ├─ Sidebar（フォルダ選択 + ドキュメントツリー）
  └─ TipTap Editor（編集）
        │
        ▼
[Application Service]
  ├─ AuthSessionService（認証状態/ガード）
  ├─ VaultService（選択・復元）
  ├─ NoteIndexService（走査・索引）
  └─ NotePersistenceService（読み書き）
        │
        ▼
[Backend API]
  └─ Auth API（better-auth）
        │
        ▼
[Tauri Plugins]
  ├─ dialog（フォルダ選択）
  ├─ fs（読み書き）
  └─ store（設定保持）
```

## 5. UI/UX 設計

### 5.1 画面構成

- 未認証状態では Login / SignUp 画面を表示し、Workspace 画面には遷移させない
- 認証済み状態では左ペイン（サイドバー）に Vault/フォルダ選択とドキュメントツリーを表示する
- サイドバーには選択中フォルダ配下のフォルダ名・ファイル名（`.md`）をツリー構造で表示する
- ツリー項目クリックで対象ノートを開く
- 右ペインには Notion ライクな編集体験を提供する TipTap ベースの Markdown エディタを表示する

### 5.2 主要操作

- 起動時にセッション確認し、未認証ならログインへ遷移
- 認証成功後に Workspace を表示
- 初回 Workspace 表示時に Vault フォルダを選択
- サイドバーのツリーでノートを選択して内容ロード
- ノートの新規作成（ツリー上のフォルダ文脈で作成）
- 編集内容はデバウンス保存（例: 500ms）
- 保存失敗時は UI に明示

### 5.3 編集体験

- 見出し、段落、箇条書き、引用、コードブロック
- チェックリストは「Markdown の一要素」として扱う（専用 ToDo 機能にはしない）
- スラッシュメニューやショートカットは段階的に導入

## 6. データモデル

### 6.1 ノート実体

- 1 ノート = 1 Markdown ファイル
- 文字コードは UTF-8
- 改行は LF

### 6.2 インデックス項目

- `id`: 正規化したファイルパス
- `path`: Vault 相対パス
- `name`: サイドバー表示名（ファイル名またはフォルダ名）
- `kind`: `file` または `folder`
- `updatedAt`: ファイル更新時刻

## 7. アプリケーション層の責務

### 7.1 AuthSessionService

- セッション確認（`/api/me`）
- 認証ガード（未認証時の Workspace 遷移禁止）
- サインアウト時のセッション破棄とログイン画面遷移

### 7.2 VaultService

- Vault パスの選択と検証
- 最後に使用した Vault の復元
- Vault 未選択時のガード制御

### 7.3 NoteIndexService

- 起動時の `*.md` スキャン
- サイドバー用のフォルダ/ファイルツリーをメモリ上に索引化
- フォルダ優先 + 名前順で表示順を統一

### 7.4 NotePersistenceService

- ファイル読み込み
- テキスト保存（原子的更新を推奨）
- 競合時の再読込通知

## 8. 既存コードからの移行設計

### 8.1 段階移行

1. 新規ルート `workspace` を追加し、新 UI を先行実装
2. 既存 `login/signup` は維持し、`workspace` を認証ガード下に配置
3. API クライアントは「認証API用」と「ローカルMarkdown用」に責務分離
4. 最終的にカンバン関連コンポーネントを削除

### 8.2 削除対象（ToDo要素）

- `BoardRoute` の機能要件と画面導線
- カード CRUD と並び替え処理
- `/api/cards`, `/api/reorder` への依存コード

### 8.3 暫定維持対象

- `backend` は認証API提供のため維持する
- カード管理 API は段階的に未使用化し、最終的に削除する

## 9. 品質要件

### 9.1 性能

- 1,000 ファイル規模で一覧初期表示 1 秒台を目標
- エディタ入力時に体感遅延を発生させない

### 9.2 信頼性

- アプリ異常終了時の保存破損を最小化
- 保存失敗時は失敗理由を UI 表示

### 9.3 セキュリティ/プライバシー

- データはローカル完結を基本とする
- 外部送信は明示機能追加時のみ

## 10. マイルストーン

### M1: ローカル基盤

- 認証ガード下での Workspace ルーティング
- Vault 選択
- サイドバーのドキュメントツリー表示
- テキスト読み書き

### M2: TipTap 編集体験

- Markdown 入出力
- 基本ブロック編集
- 自動保存

### M3: 使い勝手向上

- 検索
- ノート作成/リネーム/削除
- エラー通知の改善

## 11. 受け入れ基準

- 未認証ユーザーは Workspace（Markdown 管理画面）にアクセスできない
- 認証成功ユーザーは Workspace に遷移できる
- 認証済みセッション中は Markdown の編集・保存が成立する
- `*.md` を外部エディタで編集後、再読込で内容が一致する
- ToDo/カンバン専用 UI がアプリ導線から除去されている

## 12. 今後の拡張候補（任意）

- ノート間リンク
- GitHubレポジトリ連携
- ページ公開機能
- 画像Storage機能
